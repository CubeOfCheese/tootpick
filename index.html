<!DOCTYPE html>
<meta charset=UTF-8>
<title>Tootpick</title>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta http-equiv=Content-Security-Policy content="default-src 'self' 'unsafe-inline' https:; connect-src https:; img-src  https:">
<meta http-equiv=Referrer-Policy content=no-referrer>
<style>
	* {
		box-sizing: border-box;
	}
	html {
		height: 100%;
		padding: 0;
		margin: 0;
	}
	body {
		padding: 0;
		margin: 0;
		display: flex;
		min-height: 100%;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		background: #191b22;
		background-size: cover;
		line-height: 120%;
		color: white;
		font-family: sans-serif;
		font-size: 15px;
	}
	body * {
		font: inherit;
		border: 0;
		border-radius: 4px;
	}
	:focus {
		outline: 1px dashed white;
		outline-offset: 2px;
	}
	::placeholder {
		font-style: italic;
		color: #666;
	}
	a {
		color: inherit;
		text-decoration: underline;
	}
	a:hover {
		filter: brightness(150%);
	}
	main {
		display: flex;
		flex-direction: column;
		gap: .8em;
		background: #444b5d;
		border-radius: 0;
		padding: .8em;
		max-width: 40rem;
		margin-top: auto;
		margin-bottom: auto;
	}
	#message {
		margin: 0;
		background: white;
		padding: .5em;
		width: 100%;
		background: #eee;
		color: #222;
		max-height: 9em;
		overflow: auto;
		cursor: not-allowed;
	}
	#message:hover {
		background: #ccc;
		color: #888;
	}
	#inputline {
		display: flex;
		align-items: center;
		gap: .5em;
		flex-wrap: wrap;
	}
	#inputline label {
		flex: 1 0 auto;
		display: flex;
		align-items: center;
	}
	#inputline span#server {
		white-space: nowrap;
		margin-right: .5em;
	}
	input#instance {
		padding: .2em .5em;
		flex: 1 1 30em;
		min-width: 10em;
	}
	input#instance:focus {
		outline: 0;
	}
	button, input[type="submit"] {
		background: #5455ff;
		color: #fff;
		padding: 7px 10px;
		font-weight: 500;
		font-size: 15px;
		cursor: pointer;
	}
	button:hover, input[type="submit"]:hover {
		background: #6364ff;
	}
	#toot {
		margin-left: auto;
	}
	#recent {
		display: flex;
		justify-content: space-around;
		flex-wrap: wrap;
		gap: .5em;
	}
	#recent > button {
		flex: 0 1 140px;
		display: flex;
		flex-direction: column;
		gap: .5em;
		padding-top: .5em;
		position: relative;
		margin-top: 1em;
	}
	#recent > button img {
		width: 120px;
		aspect-ratio: 1200/630;
		object-fit: cover;
	}
	button.delete {
		background: black;
		color: #df405a;
		position: absolute;
		padding: .2em .3em;
		top: .2em;
		right: .2em;
	}
	button.delete::after {
		content: '\002716';  /* HEAVY MULTIPLICATION X */
	}
	button.delete:hover {
		background: #df405a;
		color: white;
	}
	footer {
		color: #aaa;
		padding: 1em;
		text-align: center;
	}
	.error {
		padding: .5em;
		background: #df405a;
		color: black;
	}
	.hidden {
		display: none !important;
	}
</style>

<script>
	let message;
	let notMastodon = 'That does not appear to be a Mastodon server.';

	function $(q) {
		return document.querySelector(q);
	}

	function error(msg) {
		let el = $('#errorline');
		if (msg && typeof msg == 'string') {
			el.innerText = msg;
			el.classList.remove('hidden');
		} else {
			el.classList.add('hidden');
		}
	}

	function setLocationGlobals() {
		let hash = document.location.hash.replace(/^#/, '');
		let args = {};
		for (let arg of hash.split('&')) {
			let [k, v] = arg.split('=');
			args[ decodeURIComponent(k) ] = decodeURIComponent(v);
		}
		message = args['text'] || "Create a 'share with Mastodon' link on your website using Tootpick! https://tootpick.org/ #mastodon #tootpick";

		$("#message").innerText = message;
	}

	function getRecent() {
		return JSON.parse(localStorage.getItem('recent') || '[]');
	}

	function setRecent(obj) {
		// Deduplicate
		let seen = {};
		obj = obj.filter(x => {
			let key = x['domain'];
			return seen[key] ? false : (seen[key] = true);
		});

		// The box will show 2, 3, or 4 per row, limit of 12 ensures
		// truncating at a whole row.
		if (recent.length > 12) recent.length = 12;

		localStorage.setItem('recent', JSON.stringify(obj));
	}

	function populateRecent() {
		let recent = getRecent();

		if (!recent.length) {
			$("#recent").classList.add('hidden');
			return;
		}

		$('#recent').innerHTML = '';

		for (let item of getRecent()) {
			let div = document.createElement('button');
			div.dataset['instance'] = JSON.stringify(item);
			let img = document.createElement('img');
			img.src = item['thumbnail'];
			let del = document.createElement('button');
			del.classList.add('delete');
			del.setAttribute('title', 'Forget ' + item['domain']);
			let text = document.createElement('div');
			text.innerText = "Continue with\n" + item['domain'];

			div.setAttribute('title', item['title']);
			div.appendChild(del);
			div.appendChild(img);
			div.appendChild(text);
			$('#recent').appendChild(div);
		}
	}

	function tootRedirect(domain, message) {
		document.location = `https://${domain}/share?text=${ encodeURIComponent(message) }`;
	}

	function tryNewInstance(domain, message) {
		fetch(`https://${domain}/api/v1/instance`)
		.then((resp) => resp.json())
		.then(function (data) {
			if (!data['version']) {
				error(notMastodon);
				return;
			}
			let thumbnail = data['thumbnail'];
			let title = data['title'];

			document.body.style.backgroundImage = `url(${thumbnail})`;

			if ($('#remember').checked) {
				let recent = getRecent();
				recent.unshift({ domain, thumbnail, title });
				setRecent(recent);
			}

			setTimeout(() => tootRedirect(domain, message), 1000);
		})
		.catch((err) => error(notMastodon));
	}

	window.addEventListener('hashchange', setLocationGlobals);

	window.addEventListener('pageshow', () => {
		setLocationGlobals();
		populateRecent();

		$("#instance").addEventListener('keydown', error);
		$("#instance").addEventListener('click', error);

		$("form").addEventListener('submit', (e) => {
			e.preventDefault();

			// domain is expected, but user might enter URL
			let instance = $("#instance").value.trim();

			// remove trailing slash and username, if present
			instance = instance.replace(/\/+(?:@.*)?$/, "");

			// newbies may write https:foo or https//foo too.
			instance = instance.replace(/^https?\W+/, "");

			// Check whether the input is a valid domain name, in order to
			// prevent leaking e.g. pasted clipboard text (passwords, credit
			// card numbers, love letters, ...) via DNS. Can't prevent
			// every mistake, but let's catch at least the obvious cases.
			if (! instance.match(/^(?:(?:xn--)?[a-z0-9]+[-.])*[a-z0-9]+\.[a-z]{2,}$/i)) {
				// TODO: support user readable IDN and %-encoded IDN (both uncommon)
				error('Not a valid internet domain name.');
				return;
			}

			$("#instance").value = instance;

			tryNewInstance(instance, message);
		});

		$("#recent").addEventListener('click', (event) => {
			let button = event.target.closest('button');
			if (!button) return;


			if (button.classList.contains('delete')) {
				let instance = JSON.parse( button.parentElement.dataset['instance'] );

				setRecent(getRecent().filter(
					x => x['domain'] != instance['domain']
				));

				button.parentElement.remove();
			} else {
				let instance = JSON.parse( button.dataset['instance'] );
				document.body.style.backgroundImage = `url(${ instance['thumbnail'] })`;

				let recent = getRecent();
				recent.unshift(instance);
				setRecent(recent);

				tootRedirect(instance['domain'], message);
			}
		});
	});
</script>

<header class=error>
	Note: this service is under construction and doesn't do anything useful yet.
</header>

<main>
	<noscript>
		<div class=error>
		Please enable JavaScript to use this service. This page requires
		JavaScript to keep all the data in your browser. The alternative would
		be to send message contents to the server, which would be the worse
		decision privacy-wise.
		</div>
	</noscript>
	<div>
		Pick your Mastodon server to toot this message:
	</div>
	<blockquote id=message
		title="You can edit the text on the next page, on your own Mastodon server.">
	</blockquote>
	<form id=inputline>
		<label title="Enter the domain name of your Mastodon server (sometimes called 'instance')">
			<span id=server>Server:</span>
			<input id=instance placeholder="social.example.org">
		</label>
		<label>
			<input type=checkbox id=remember checked> Remember
		</label>
		<input type=submit id=toot value="Continue">
	</form>
	<div id=errorline class="error hidden">
	</div>
	<div id=recent>
	</div>
</main>
<footer>
	<a href="https://github.com/Juerd/tootpick">Tootpick</a> is a
	privacy preserving instance picker for sharing links from
	news sites, blogs, etc.<br>(Free software under the AGPLv3 license.)
</footer>
